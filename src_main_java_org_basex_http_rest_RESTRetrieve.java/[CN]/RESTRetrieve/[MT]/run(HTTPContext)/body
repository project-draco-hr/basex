{
  open(http);
  final Session session=http.session();
  if (http.depth() == 0) {
    final Table table=new Table(session.execute(new List()));
    final SerializerProp sprop=new SerializerProp(http.serialization);
    final Serializer ser=Serializer.get(http.out,sprop);
    http.initResponse(sprop);
    ser.openElement(DATABASES,RESOURCES,token(table.contents.size()));
    ser.namespace(REST,RESTURI);
    list(table,ser,DATABASE,1);
    ser.closeElement();
    ser.close();
  }
 else   if (!exists(http)) {
    final Table table=new Table(session.execute(new ListDB(http.path())));
    if (table.contents.isEmpty())     throw new HTTPException(SC_NOT_FOUND,ERR_NORES);
    final String serial=http.serialization;
    final SerializerProp sprop=new SerializerProp(serial);
    final Serializer ser=Serializer.get(http.out,sprop);
    http.initResponse(sprop);
    ser.openElement(DATABASE,DataText.T_NAME,token(http.db()),RESOURCES,token(table.contents.size()));
    ser.namespace(REST,RESTURI);
    list(table,ser,RESOURCE,0);
    ser.closeElement();
    ser.close();
  }
 else   if (isRaw(http)) {
    final String type=contentType(http);
    if (type.equals(MimeTypes.APP_XQUERY)) {
      final ArrayOutput ao=new ArrayOutput();
      session.setOutputStream(ao);
      session.execute(new Retrieve(http.dbpath()));
      query(ao.toString(),http);
    }
 else {
      final String ct=SerializerProp.S_MEDIA_TYPE[0] + "=" + type;
      http.initResponse(new SerializerProp(ct + ',' + http.serialization));
      session.setOutputStream(http.out);
      session.execute(new Retrieve(http.dbpath()));
    }
  }
 else {
    http.initResponse(new SerializerProp(http.serialization));
    session.execute(new Set(Prop.SERIALIZER,serial(http)));
    session.setOutputStream(http.out);
    session.query(".").execute();
  }
}
