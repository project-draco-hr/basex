{
  Session s=null;
  try {
    s=factory.login(user,pass);
    s.execute(new Open(db));
    final String doc=path.isEmpty() ? newName : path + SEP + newName;
    if (count(s,db,doc) == 0) {
      s.add(newName,path,inputStream);
      deleteDummy(s,db,path);
    }
 else {
      s.replace(doc,inputStream);
    }
    s.execute(new Close());
    return new BXDocument(db,doc,factory,user,pass);
  }
 catch (  final Exception ex) {
    handle(ex);
    throw new BadRequestException(this,ex.getMessage());
  }
 finally {
    try {
      if (s != null)       s.close();
    }
 catch (    final IOException e) {
      handle(e);
    }
  }
}
