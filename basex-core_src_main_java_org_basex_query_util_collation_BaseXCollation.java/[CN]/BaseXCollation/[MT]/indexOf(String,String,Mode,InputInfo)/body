{
  if (!(collator instanceof RuleBasedCollator))   throw CHARCOLL.get(info);
  final RuleBasedCollator rbc=(RuleBasedCollator)collator;
  final CollationElementIterator st=rbc.getCollationElementIterator(string);
  final CollationElementIterator sb=rbc.getCollationElementIterator(sub);
  do {
    final int cs=next(sb);
    if (cs == -1)     return 0;
    int c;
    do {
      c=next(st);
      if (c == -1)       return -1;
    }
 while (c != cs);
    final int s=st.getOffset();
    if (startsWith(st,sb)) {
      if (mode == Mode.INDEX_AFTER) {
        return st.getOffset();
      }
 else       if (mode == Mode.ENDS_WITH) {
        if (next(st) == -1)         return s - 1;
      }
 else {
        return s - 1;
      }
    }
    st.setOffset(s);
    sb.reset();
  }
 while (mode != Mode.STARTS_WITH);
  return -1;
}
