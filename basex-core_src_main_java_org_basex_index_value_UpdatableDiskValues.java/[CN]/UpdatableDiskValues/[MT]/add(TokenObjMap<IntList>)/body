{
  final int s=size();
  final int last=s - 1;
  final TokenList allkeys=new TokenList(map).sort(true);
  final TokenList nkeys=new TokenList(map.size());
  int p=0;
  for (  final byte[] key : allkeys) {
    p=get(key,p,s);
    if (p < 0) {
      p=-(p + 1);
      nkeys.add(key);
    }
 else {
      appendIds(p++,key,diffs(map.get(key)));
    }
  }
  for (int j=nkeys.size() - 1, i=last, pos=s + j; j >= 0; --j) {
    final byte[] key=nkeys.get(j);
    final int in=-(1 + get(key,0,i + 1));
    if (in < 0)     throw Util.notExpected("Key should not exist: '" + string(key) + '\'');
    while (i >= in) {
      idxr.write5(pos * 5L,idxr.read5(i * 5L));
      ctext.put(pos--,ctext.get(i--));
    }
    idxr.write5(pos * 5L,idxl.appendNums(diffs(map.get(key))));
    ctext.put(pos--,key);
  }
  size(s + nkeys.size());
}
