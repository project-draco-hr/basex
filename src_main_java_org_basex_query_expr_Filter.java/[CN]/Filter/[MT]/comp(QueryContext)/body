{
  root=checkUp(root,ctx).comp(ctx);
  if (root instanceof AxisPath && !super.uses(Use.POS))   return ((AxisPath)root).copy().addPreds(pred).comp(ctx);
  if (root.empty())   return optPre(Empty.SEQ,ctx);
  final Type ct=ctx.resource.value != null ? ctx.resource.value.type : null;
  if (ct != null)   ctx.resource.value.type=root.type().type;
  final Expr e=super.comp(ctx);
  if (e != this)   return e;
  if (ct != null)   ctx.resource.value.type=ct;
  if (pred.length == 0)   return root;
  final SeqType t=root.type();
  type=SeqType.get(t.type,t.zeroOrOne() ? SeqType.Occ.ZO : SeqType.Occ.ZM);
  if (!super.uses(Use.POS))   return new IterFilter(this);
  if (iterable()) {
    if (pred.length == 1 && (last || pos != null)) {
      if (root.type().one() && (last || pos.min == 1 && pos.max == 1))       return optPre(root,ctx);
      if (root.value())       return optPre(iter(ctx).finish(),ctx);
    }
    return new IterPosFilter(this);
  }
  off=pred.length == 1 && pred[0].type().num() && !pred[0].uses(Use.CTX);
  return this;
}
