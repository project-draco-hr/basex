{
  final Var v=current.get(name);
  if (v != null)   return new LocalVarRef(ii,v);
  if (parent != null) {
    final VarRef nonLocal=parent.resolve(name,qp,ctx,ii,err);
    if (!(nonLocal instanceof LocalVarRef))     return nonLocal;
    final Var local=new Var(ctx,name,nonLocal.type());
    add(local);
    closure.put(local,nonLocal);
    return new LocalVarRef(ii,local);
  }
  GlobalVar global=ctx.globals.get(name);
  if (global == null && err != null)   throw qp.error(err,'$' + string(name.string()));
  return global;
}
