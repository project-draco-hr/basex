{
  final DefaultDocumentEvent changes=new DefaultDocumentEvent(off,len,DocumentEvent.EventType.CHANGE);
  buffer.change(off,len,changes);
  final AttributeSet sCopy=s.copyAttributes();
  int lastEnd=Integer.MAX_VALUE;
  for (int pos=off; pos < (off + len); pos=lastEnd) {
    final Element run=getCharacterElement(pos);
    lastEnd=run.getEndOffset();
    if (pos == lastEnd)     break;
    MutableAttributeSet attr=(MutableAttributeSet)run.getAttributes();
    changes.addEdit(new AttributeUndoableEdit(run,sCopy,rep));
    if (rep)     attr.removeAttributes(attr);
    attr.addAttributes(s);
  }
  changes.end();
  fireChangedUpdate(changes);
  fireUndoableEditUpdate(new UndoableEditEvent(this,changes));
}
