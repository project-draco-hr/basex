{
  final MemData mdata;
  if (doc.node()) {
    final ANode nd=(ANode)doc;
    if (nd.ndType() != NodeType.DOC)     UPDOCTYPE.thrw(input,nd);
    mdata=new MemData(data);
    new DataBuilder(mdata).build(nd);
  }
 else   if (doc.str()) {
    final String docpath=string(doc.atom(input));
    final String nm=ctx.mprop.random(data.meta.name);
    final DirParser p=new DirParser(IO.get(docpath),ctx.prop);
    final MemBuilder b=new MemBuilder(nm,p,ctx.prop);
    try {
      mdata=b.build();
    }
 catch (    final IOException ex) {
      throw IOERR.thrw(input,ex);
    }
  }
 else {
    throw STRNODTYPE.thrw(input,this,doc.type);
  }
  final IntList pres=mdata.docs();
  if (pres.size() == 1 && name != null) {
    final byte[] nm=path == null ? name : concat(path,SLASH,name);
    mdata.update(pres.get(0),Data.DOC,nm);
  }
 else   if (path != null) {
    for (int i=0, is=pres.size(); i < is; i++) {
      final int d=pres.get(i);
      final byte[] old=mdata.text(d,true);
      final int p=lastIndexOf(old,'/');
      final byte[] nm=p < 0 ? old : subtoken(old,p + 1);
      mdata.update(d,Data.DOC,concat(path,SLASH,nm));
    }
  }
  return mdata;
}
