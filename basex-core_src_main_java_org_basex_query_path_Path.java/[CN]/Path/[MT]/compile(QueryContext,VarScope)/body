{
  if (root != null)   root=root.compile(qc,scp);
  final Value init=qc.value, cv=initial(qc);
  final boolean doc=cv != null && cv.type == NodeType.DOC;
  qc.value=cv;
  try {
    for (int s=0; s < steps.length; s++) {
      Expr e=steps[s];
      final boolean as=e instanceof Step;
      if (as && s == 0 && doc)       cv.type=NodeType.NOD;
      e=e.compile(qc,scp);
      if (e.isEmpty())       return optPre(null,qc);
      steps[s]=e;
      if (!as)       qc.value=null;
    }
  }
  finally {
    if (doc)     cv.type=NodeType.DOC;
    qc.value=init;
  }
  if (steps.length == 0)   return root == null ? new Context(info) : root;
  return optimize(qc,scp);
}
