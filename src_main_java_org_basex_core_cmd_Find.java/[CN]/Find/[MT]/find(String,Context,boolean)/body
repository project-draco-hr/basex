{
  if (query.startsWith("/"))   return query;
  final boolean r=root || ctx.root();
  if (query.isEmpty())   return r ? "/" : ".";
  final Data data=ctx.data;
  if (data.fs != null)   return findFS(query,ctx,root);
  final String qu=query.replaceAll(" \\+"," ");
  final String[] terms=split(qu);
  String pre="";
  String preds="";
  final String tag="*";
  for (  String term : terms) {
    if (term.startsWith("@=")) {
      preds+="[@* = \"" + term.substring(2) + "\"]";
    }
 else     if (term.startsWith("=")) {
      preds+="[text() = \"" + term.substring(1) + "\"]";
    }
 else     if (term.startsWith("~")) {
      preds+="[text() contains text \"" + term.substring(1) + "\" using fuzzy]";
    }
 else     if (term.startsWith("@")) {
      if (term.length() == 1)       continue;
      preds+="[@* " + CT + " \""+ term.substring(1)+ "\"]";
      term=term.substring(1);
      if (XMLToken.isName(token(term))) {
        pre+=(r ? "" : ".") + "//@" + term+ " | ";
      }
    }
 else {
      preds+="[text() " + CT + " \""+ term+ "\"]";
      if (XMLToken.isName(token(term))) {
        pre+=(r ? "/" : "") + Axis.DESC + "::*:"+ term+ " | ";
      }
      pre+=(r ? "/" : "") + Axis.DESCORSELF + "::*[@name "+ CT+ " \""+ term+ "\"] | ";
    }
  }
  if (pre.isEmpty() && preds.isEmpty())   return root ? "/" : ".";
  final TokenBuilder opt=new TokenBuilder();
  final MetaData md=data.meta;
  if (md.ftindex) {
    if (md.wildcards)     opt.add(' ' + USING + ' '+ WILDCARDS);
    if (md.stemming)     opt.add(' ' + USING + ' '+ STEMMING);
    if (md.casesens)     opt.add(' ' + USING + ' '+ CASE+ ' '+ SENSITIVE);
    if (md.diacritics)     opt.add(' ' + USING + ' '+ DIACRITICS+ ' '+ SENSITIVE);
    if (md.language != null)     opt.add(' ' + USING + ' '+ LANGUAGE+ " '"+ md.language+ "'");
  }
  final TokenBuilder tb=new TokenBuilder();
  if (opt.size() != 0)   tb.add("declare ft-option" + opt + "; ");
  tb.add(pre + (r ? "/" : "") + Axis.DESCORSELF+ "::"+ tag+ preds);
  return tb.toString();
}
