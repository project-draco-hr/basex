{
  if (READER == null)   return io;
  try {
    byte[] content=io.read();
    final TextInput ti=new TextInput(new IOContent(content));
    String enc=ti.encoding();
    content=ti.readBytes();
    final byte[] encoding=token("charset=");
    int cs=indexOf(content,encoding);
    if (cs > 0) {
      cs+=encoding.length;
      int ce=cs;
      while (++ce < content.length && content[ce] > 0x28)       ;
      enc=string(substring(content,cs,ce));
    }
    final InputSource is=new InputSource(new ArrayInput(content));
    is.setEncoding(supported(enc) ? normEncoding(enc) : UTF8);
    final StringWriter sw=new StringWriter();
    final XMLReader reader=(XMLReader)Reflect.get(READER);
    final Object writer=Reflect.get(WRITER,sw);
    final HTMLProp props=new HTMLProp(options);
    String p="";
    if (props.is(HTMLProp.HTML)) {
      reader.setFeature("http://xml.org/sax/features/namespaces",false);
      opt("method","html");
      opt("omit-xml-declaration","yes");
    }
    if (props.is(HTMLProp.NONS)) {
      reader.setFeature("http://xml.org/sax/features/namespaces",false);
    }
    if (props.is(HTMLProp.OMITXML)) {
      opt("omit-xml-declaration","yes");
    }
    if ((p=props.get(HTMLProp.METHOD)) != null) {
      opt("method",p);
    }
    if (props.is(HTMLProp.NOBOGONS)) {
      reader.setFeature(FEATURES + "ignore-bogons",true);
    }
    if (props.is(HTMLProp.NODEFAULTS)) {
      reader.setFeature(FEATURES + "default-attributes",false);
    }
    if (props.is(HTMLProp.NOCOLONS)) {
      reader.setFeature(FEATURES + "translate-colons",true);
    }
    if (props.is(HTMLProp.NORESTART)) {
      reader.setFeature(FEATURES + "restart-elements",false);
    }
    if (props.is(HTMLProp.IGNORABLE)) {
      reader.setFeature(FEATURES + "ignorable-whitespace",true);
    }
    if (props.is(HTMLProp.EMPTYBOGONS)) {
      reader.setFeature(FEATURES + "bogons-empty",true);
    }
    if (props.is(HTMLProp.ANY)) {
      reader.setFeature(FEATURES + "bogons-empty",false);
    }
    if (props.is(HTMLProp.NOROOTBOGONS)) {
      reader.setFeature(FEATURES + "root-bogons",false);
    }
    if (props.is(HTMLProp.NOCDATA)) {
      reader.setFeature(FEATURES + "cdata-elements",false);
    }
    if (props.is(HTMLProp.LEXICAL)) {
      reader.setProperty("http://xml.org/sax/properties/lexical-handler",writer);
    }
    if ((p=props.get(HTMLProp.DOCTYPESYS)) != null) {
      opt("doctype-system",p);
    }
    if ((p=props.get(HTMLProp.DOCTYPEPUB)) != null) {
      opt("doctype-public",p);
    }
    if ((p=props.get(HTMLProp.ENCODING)) != null) {
      is.setEncoding(p);
    }
    reader.setContentHandler((ContentHandler)writer);
    reader.parse(is);
    return new IOContent(token(sw.toString()),io.name());
  }
 catch (  final SAXException ex) {
    Util.errln(ex);
    return io;
  }
}
