{
  if (info)   Main.outln(this + " Login: " + context.user.name);
  try {
    while (true) {
      String in=null;
      try {
        in=dis.readUTF();
      }
 catch (      final IOException ex) {
        exit();
        break;
      }
      final Performance perf=new Performance();
      Process proc=null;
      try {
        proc=new CommandParser(in,context,true).parse()[0];
        if (proc instanceof IntInfo) {
          String inf=core.info();
          if (inf.equals(PROGERR))           inf=SERVERTIME;
          new DataOutputStream(out).writeUTF(inf);
          out.flush();
        }
 else         if (proc instanceof Exit) {
          exit();
          break;
        }
 else {
          core=proc;
          startTimer(proc);
          final boolean up=proc.updating(context) || (proc.flags & User.CREATE) != 0;
          sem.before(up);
          final boolean ok=proc.execute(context,out);
          out.write(new byte[IO.BLOCKSIZE]);
          send(ok);
          stopTimer();
          sem.after(up);
        }
      }
 catch (      final QueryException ex) {
        proc=new IntError(ex.extended());
        core=proc;
        out.write(new byte[IO.BLOCKSIZE]);
        send(false);
      }
      if (info)       Main.outln(this + " " + in+ ": "+ perf);
    }
    if (info)     Main.outln(this + " Logout: " + context.user.name);
  }
 catch (  final IOException ex) {
    Main.error(ex,false);
  }
}
