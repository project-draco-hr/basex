{
  refreshControls(false);
  final byte[] in=editor.getText();
  final boolean eq=eq(in,editor.last);
  if (eq && action == Action.CHECK)   return;
  IOFile file=editor.file;
  editor.last=in;
  final boolean xquery=file.hasSuffix(IO.XQSUFFIXES) || !file.path().contains(".");
  editor.script=!xquery && file.hasSuffix(IO.BXSSUFFIX);
  if (action == Action.EXECUTE && editor.script) {
    gui.execute(true,new Execute(string(in)));
  }
 else   if (xquery || action == Action.EXECUTE) {
    String input=in.length == 0 ? "()" : string(in);
    boolean main=!QueryProcessor.isLibrary(input);
    final boolean exec=action == Action.EXECUTE || gui.gopts.get(GUIOptions.EXECRT);
    if (exec) {
      final EditorArea ea=execEditor();
      if (ea != null) {
        file=ea.file;
        input=string(ea.getText());
        main=true;
      }
    }
    if (main && exec) {
      gui.execute(true,new XQuery(input));
      execFile=file;
    }
 else {
      gui.context.options.set(MainOptions.QUERYPATH,file.path());
      final QueryContext qc=new QueryContext(gui.context);
      try {
        if (main)         qc.parseMain(input,null,null);
 else         qc.parseLibrary(input,null,null);
        info(OK,true,false);
      }
 catch (      final QueryException ex) {
        info(Util.message(ex),false,false);
      }
 finally {
        qc.close();
      }
    }
  }
 else   if (editor.script || file.hasSuffix(IO.XMLSUFFIXES) || file.hasSuffix(IO.XSLSUFFIXES)|| file.hasSuffix(IO.HTMLSUFFIXES)) {
    try {
      if (startsWith(in,'<') || !editor.script)       new EmptyBuilder(new IOContent(in),gui.context).build();
      if (editor.script)       new CommandParser(string(in),gui.context).parse();
      info(OK,true,false);
    }
 catch (    final Exception ex) {
      info(Util.message(ex),false,false);
    }
  }
 else   if (action != Action.CHECK) {
    info(OK,true,false);
  }
}
