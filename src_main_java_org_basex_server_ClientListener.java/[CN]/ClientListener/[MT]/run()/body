{
  try {
    final String ts=Long.toString(System.nanoTime());
    final byte[] address=socket.getInetAddress().getAddress();
    out=PrintOutput.get(socket.getOutputStream());
    out.print(ts);
    send(true);
    in=new BufferInput(socket.getInputStream());
    final String us=in.readString();
    final String pw=in.readString();
    context.user=context.users.get(us);
    running=context.user != null && md5(string(context.user.password) + ts).equals(pw);
    if (running) {
      log.write(this,"LOGIN " + context.user.name,OK);
      send(true);
      server.unblock(address);
      context.add(this);
    }
 else     if (!us.isEmpty()) {
      log.write(this,SERVERDENIED + COLS + us);
      new ClientDelayer(server.block(address),this,server);
    }
  }
 catch (  final IOException ex) {
    Util.stack(ex);
    log.write(ex.getMessage());
  }
  ServerCmd sc=null;
  String cmd=null;
  try {
    while (running) {
      try {
        final int b=in.read();
        if (b == -1) {
          exit();
          break;
        }
        last=System.currentTimeMillis();
        perf.getTime();
        sc=get(b);
        cmd=null;
        if (sc == CREATE) {
          create();
        }
 else         if (sc == ADD) {
          add();
        }
 else         if (sc == WATCH) {
          watch();
        }
 else         if (sc == UNWATCH) {
          unwatch();
        }
 else         if (sc == REPLACE) {
          replace();
        }
 else         if (sc == STORE) {
          store();
        }
 else         if (sc != COMMAND) {
          query(sc);
        }
 else {
          cmd=new ByteList().add(b).add(in.readBytes()).toString();
        }
      }
 catch (      final IOException ex) {
        exit();
        break;
      }
      if (sc != COMMAND)       continue;
      command=null;
      try {
        command=new CommandParser(cmd,context).parseSingle();
      }
 catch (      final QueryException ex) {
        final String msg=ex.getMessage();
        log.write(this,cmd,INFOERROR + msg);
        out.write(0);
        out.writeString(msg);
        send(false);
        continue;
      }
      command.startTimeout(context.mprop.num(MainProp.TIMEOUT));
      log.write(this,command.toString().replace('\r',' ').replace('\n',' '));
      boolean ok=true;
      String info=null;
      try {
        command.execute(context,new EncodingOutput(out));
        info=command.info();
      }
 catch (      final BaseXException ex) {
        ok=false;
        info=ex.getMessage();
        if (info.startsWith(PROGERR))         info=SERVERTIMEOUT;
      }
      command.stopTimeout();
      out.write(0);
      info(info,ok);
      if (command instanceof Exit) {
        exit();
        break;
      }
    }
  }
 catch (  final IOException ex) {
    log.write(this,sc == COMMAND ? cmd : sc,INFOERROR + ex.getMessage());
    Util.stack(ex);
    exit();
  }
}
