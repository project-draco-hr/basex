{
  String arg=in.readString();
  String err=null;
  try {
    final QueryListener qp;
    if (sc == ServerCmd.QUERY) {
      final String query=arg;
      qp=new QueryListener(query,context);
      arg=Integer.toString(id++);
      queries.put(arg,qp);
      out.writeString(arg);
      log.write(this,sc + "(" + arg+ ')',query,OK,perf);
    }
 else {
      qp=queries.get(arg);
      if (qp == null) {
        if (sc != ServerCmd.CLOSE)         throw new IOException("Unknown Query ID: " + arg);
      }
 else       if (sc == ServerCmd.BIND) {
        final String key=in.readString();
        final String val=in.readString();
        final String typ=in.readString();
        qp.bind(key,val,typ);
        log.write(this,sc + "(" + arg+ ')',key,val,typ,OK,perf);
      }
 else       if (sc == ServerCmd.CONTEXT) {
        final String val=in.readString();
        final String typ=in.readString();
        qp.context(val,typ);
        log.write(this,sc + "(" + arg+ ')',val,typ,OK,perf);
      }
 else       if (sc == ServerCmd.ITER) {
        qp.execute(true,out,true,false);
      }
 else       if (sc == ServerCmd.EXEC) {
        qp.execute(false,out,true,false);
      }
 else       if (sc == ServerCmd.FULL) {
        qp.execute(true,out,true,true);
      }
 else       if (sc == ServerCmd.INFO) {
        out.print(qp.info());
      }
 else       if (sc == ServerCmd.OPTIONS) {
        out.print(qp.options());
      }
 else       if (sc == ServerCmd.UPDATING) {
        out.print(Boolean.toString(qp.updating()));
      }
 else       if (sc == ServerCmd.CLOSE) {
        queries.remove(arg);
      }
 else       if (sc == ServerCmd.NEXT) {
        throw new Exception("Protocol for query iteration is out-of-date.");
      }
      out.write(0);
    }
    out.write(0);
    if (sc != ServerCmd.BIND && sc != ServerCmd.CONTEXT) {
      log.write(this,sc + "(" + arg+ ')',OK,perf);
    }
  }
 catch (  final Throwable ex) {
    err=ex.getMessage();
    log.write(this,sc + "(" + arg+ ')',ERROR_C + err);
    queries.remove(arg);
  }
  if (err != null) {
    out.write(0);
    out.write(1);
    out.writeString(err);
  }
  out.flush();
}
