{
  final List<UpdatePrimitive> upd=new ArrayList<UpdatePrimitive>();
  for (int i=nodes.size() - 1; i >= 0; i--) {
    final int pre=nodes.get(i);
    final NodeUpdates n=updatePrimitives.get(pre);
    for (    final UpdatePrimitive p : n.finish()) {
      upd.add(p);
      size+=p.size();
    }
  }
  updatePrimitives=null;
  nodes=null;
  Collections.sort(upd,new UpdatePrimitiveComparator());
  return upd;
}
