{
  final SerializerOptions opts=sopts == null ? OPTIONS : sopts;
  final String ver=supported(VERSION,opts,versions);
  final String htmlver=supported(HTML_VERSION,opts,V40,V401,V50);
  html5=htmlver.equals(V50) || ver.equals(V50);
  final boolean omitDecl=opts.yes(OMIT_XML_DECLARATION);
  final boolean bom=opts.yes(BYTE_ORDER_MARK);
  final YesNoOmit sa=opts.get(STANDALONE);
  saomit=sa == YesNoOmit.OMIT;
  final String maps=opts.get(USE_CHARACTER_MAPS);
  final String enc=normEncoding(opts.get(ENCODING),true);
  try {
    encoding=Charset.forName(enc);
  }
 catch (  final Exception ex) {
    throw SERENCODING.getIO(enc);
  }
  utf8=enc == UTF8;
  if (!utf8) {
    encoder=encoding.newEncoder();
    encbuffer=new TokenBuilder();
  }
  indents=opts.get(INDENTS);
  format=opts.yes(FORMAT);
  tab=opts.yes(TABULATOR) ? '\t' : ' ';
  wPre=token(opts.get(WRAP_PREFIX));
  wrap=wPre.length != 0;
  nl=utf8(token(opts.get(NEWLINE).newline()),enc);
  itemsep=opts.contains(ITEM_SEPARATOR) ? token(opts.get(ITEM_SEPARATOR).replace("\\n","\n").replace("\\r","\r").replace("\\t","\t")) : null;
  docsys=opts.get(DOCTYPE_SYSTEM);
  docpub=opts.get(DOCTYPE_PUBLIC);
  media=opts.get(MEDIA_TYPE);
  escuri=opts.yes(ESCAPE_URI_ATTRIBUTES);
  content=opts.yes(INCLUDE_CONTENT_TYPE);
  undecl=opts.yes(UNDECLARE_PREFIXES);
  indent=opts.yes(INDENT) && format;
  webdav="webdav".equals(maps);
  if (!webdav && !maps.isEmpty())   throw SERMAP.getIO(maps);
  if (docsys.isEmpty())   docsys=null;
  if (docpub.isEmpty())   docpub=null;
  out=PrintOutput.get(os);
  final int l=opts.get(LIMIT);
  if (l != -1)   out.setLimit(l);
  if (bom) {
    if (enc == UTF8) {
      out.write(0xEF);
      out.write(0xBB);
      out.write(0xBF);
    }
 else     if (enc == UTF16LE) {
      out.write(0xFF);
      out.write(0xFE);
    }
 else     if (enc == UTF16BE) {
      out.write(0xFE);
      out.write(0xFF);
    }
  }
  final String supp=opts.get(SUPPRESS_INDENTATION);
  if (!supp.isEmpty()) {
    for (    final String c : supp.split("\\s+")) {
      if (!c.isEmpty())       suppress.add(c);
    }
  }
  final boolean html=this instanceof HTMLSerializer;
  final boolean xml=this instanceof XMLSerializer || this instanceof XHTMLSerializer;
  if (xml || html) {
    final String cdse=opts.get(CDATA_SECTION_ELEMENTS);
    for (    final String c : cdse.split("\\s+")) {
      if (c.isEmpty())       continue;
      if (!html || c.contains(":") && (!html5 || !c.contains("html:")))       cdata.add(c);
    }
    if (undecl && ver.equals(V10))     throw SERUNDECL.getIO();
    if (xml) {
      if (omitDecl) {
        if (!saomit || !ver.equals(V10) && docsys != null)         throw SERSTAND.getIO();
      }
 else {
        print(PI_O);
        print(DOCDECL1);
        print(ver);
        print(DOCDECL2);
        print(opts.get(ENCODING));
        if (!saomit) {
          print(DOCDECL3);
          print(sa.toString());
        }
        print(ATT2);
        print(PI_C);
        sep=true;
      }
    }
  }
  if (wrap) {
    startElement(concat(wPre,COLON,T_RESULTS));
    namespace(wPre,token(opts.get(WRAP_URI)));
  }
}
