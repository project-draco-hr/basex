{
  final SerializerOptions opts=sopts == null ? OPTIONS : sopts;
  final String ver=opts.supported(S_VERSION,versions);
  final String htmlver=opts.supported(S_HTML_VERSION,V40,V401,V50);
  html5=htmlver.equals(V50) || ver.equals(V50);
  final boolean omitDecl=opts.yes(S_OMIT_XML_DECLARATION);
  final boolean bom=opts.yes(S_BYTE_ORDER_MARK);
  final String sa=opts.check(S_STANDALONE,YES,NO,OMIT);
  saomit=sa.equals(OMIT);
  opts.check(S_NORMALIZATION_FORM,NFC,DataText.NONE);
  final String maps=opts.string(S_USE_CHARACTER_MAPS);
  final String enc=normEncoding(opts.string(S_ENCODING));
  try {
    encoding=Charset.forName(enc);
  }
 catch (  final Exception ex) {
    throw SERENCODING.thrwSerial(enc);
  }
  utf8=enc == UTF8;
  indents=Math.max(0,toInt(opts.string(S_INDENTS)));
  format=opts.yes(S_FORMAT);
  tab=opts.yes(S_TABULATOR) ? '\t' : ' ';
  wPre=token(opts.string(S_WRAP_PREFIX));
  wrap=wPre.length != 0;
  final String eol=opts.check(S_NEWLINE,S_NL,S_CR,S_CRNL);
  nl=utf8(token(eol.equals(S_NL) ? "\n" : eol.equals(S_CR) ? "\r" : "\r\n"),enc);
  String s=opts.string(S_ITEM_SEPARATOR);
  if (s.equals(UNDEFINED))   s=opts.string(S_SEPARATOR);
  itemsep=s.equals(UNDEFINED) ? null : token(s.indexOf('\\') != -1 ? s.replace("\\n","\n").replace("\\r","\r").replace("\\t","\t") : s);
  docsys=opts.string(S_DOCTYPE_SYSTEM);
  docpub=opts.string(S_DOCTYPE_PUBLIC);
  media=opts.string(S_MEDIA_TYPE);
  escape=opts.yes(S_ESCAPE_URI_ATTRIBUTES);
  content=opts.yes(S_INCLUDE_CONTENT_TYPE);
  undecl=opts.yes(S_UNDECLARE_PREFIXES);
  indent=opts.yes(S_INDENT) && format;
  webdav=maps.equals("webdav");
  if (!webdav && !maps.isEmpty())   SERMAP.thrwSerial(maps);
  if (docsys.isEmpty())   docsys=null;
  if (docpub.isEmpty())   docpub=null;
  out=PrintOutput.get(os);
  if (bom) {
    if (enc == UTF8) {
      out.write(0xEF);
      out.write(0xBB);
      out.write(0xBF);
    }
 else     if (enc == UTF16LE) {
      out.write(0xFF);
      out.write(0xFE);
    }
 else     if (enc == UTF16BE) {
      out.write(0xFE);
      out.write(0xFF);
    }
  }
  final String supp=opts.string(S_SUPPRESS_INDENTATION);
  if (!supp.isEmpty()) {
    for (    final String c : supp.split("\\s+")) {
      if (!c.isEmpty())       suppress.add(c);
    }
  }
  final boolean html=this instanceof HTMLSerializer;
  final boolean xml=this instanceof XMLSerializer || this instanceof XHTMLSerializer;
  if (xml || html) {
    final String cdse=opts.string(S_CDATA_SECTION_ELEMENTS);
    for (    final String c : cdse.split("\\s+")) {
      if (c.isEmpty())       continue;
      if (!html || c.contains(":") && (!html5 || !c.contains("html:")))       cdata.add(c);
    }
    if (undecl && ver.equals(V10))     SERUNDECL.thrwSerial();
    if (xml) {
      if (omitDecl) {
        if (!saomit || !ver.equals(V10) && docsys != null)         SERSTAND.thrwSerial();
      }
 else {
        print(PI_O);
        print(DOCDECL1);
        print(ver);
        print(DOCDECL2);
        print(opts.string(S_ENCODING));
        if (!saomit) {
          print(DOCDECL3);
          print(sa);
        }
        print(ATT2);
        print(PI_C);
        sep=true;
      }
    }
  }
  if (wrap) {
    startElement(concat(wPre,COLON,T_RESULTS));
    namespace(wPre,token(opts.string(S_WRAP_URI)));
  }
}
