{
  final int s=ctx.vars.size();
  final ForLet[] fl=forLet();
  if (fl == null)   return null;
  Expr where=null;
  if (consumeWS(WHERE)) {
    ap=qp;
    where=check(single(),NOWHERE);
    alter=NOWHERE;
  }
  Var[] group=null;
  if (ctx.xquery11 && consumeWS(GROUP)) {
    check(BY);
    ap=qp;
    do     group=groupSpec(group);
 while (consumeWS2(COMMA));
    alter=GRPBY;
  }
  OrderBy[] order=null;
  final boolean stable=consumeWS(STABLE);
  if (stable)   check(ORDER);
  if (stable || consumeWS(ORDER)) {
    check(BY);
    ap=qp;
    do     order=orderSpec(order);
 while (consumeWS2(COMMA));
    if (order != null)     order=Array.add(order,new OrderByStable(input()));
    alter=ORDERBY;
  }
  if (!consumeWS(RETURN)) {
    if (alter != null)     error();
    error(where == null ? FLWORWHERE : order == null ? FLWORORD : FLWORRET);
  }
  final Expr ret=check(single(),NORETURN);
  ctx.vars.reset(s);
  return ret == Empty.SEQ ? ret : order == null && group == null ? new FLWR(fl,where,ret,input()) : group == null ? new FLWOR(fl,where,new Order(input(),order),ret,input()) : new GFLWOR(fl,where,order == null ? null : new Order(input(),order),new Group(input(),group),ret,input());
}
