{
  final XQuery query=new XQuery("\n" + "               <result>{\n" + "                 for $store in $stores-doc/*/store\n"+ "                 let $state := $store/state\n"+ "                 group by $state\n"+ "                 order by $state\n"+ "                 return\n"+ "                   <state name=\"{$state}\">{\n"+ "                     for $product in $products-doc/*/product\n"+ "                     let $category := $product/category\n"+ "                     group by $category\n"+ "                     order by $category\n"+ "                     return\n"+ "                       <category name=\"{$category}\">{\n"+ "                         for $sales in $sales-records-doc/*/record[store-number = $store/store-number\n"+ "                           and product-name = $product/name]\n"+ "                         let $pname := $sales/product-name\n"+ "                         group by $pname\n"+ "                         order by $pname\n"+ "                         return\n"+ "                           <product name=\"{$pname}\" total-qty=\"{sum($sales/qty)}\" />\n"+ "                         }</category>\n"+ "                   }</state>\n"+ "               }</result>\n"+ "      ",ctx);
  try {
    query.bind("$products-doc",node(file("prod/GroupByClause/products.xml")));
    query.bind("$sales-records-doc",node(file("prod/GroupByClause/sales-records.xml")));
    query.bind("$stores-doc",node(file("prod/GroupByClause/stores.xml")));
    query.bind("$books-doc",node(file("prod/GroupByClause/books.xml")));
    result=new QT3Result(query.value());
  }
 catch (  final Throwable trw) {
    result=new QT3Result(trw);
  }
 finally {
    query.close();
  }
  test(assertSerialization("<result><state name=\"CA\"><category name=\"clothes\"><product name=\"socks\" total-qty=\"510\"/></category><category name=\"kitchen\"><product name=\"broiler\" total-qty=\"20\"/><product name=\"toaster\" total-qty=\"150\"/></category></state><state name=\"MA\"><category name=\"clothes\"><product name=\"shirt\" total-qty=\"10\"/></category><category name=\"kitchen\"><product name=\"blender\" total-qty=\"250\"/><product name=\"toaster\" total-qty=\"50\"/></category></state><state name=\"WA\"><category name=\"clothes\"/><category name=\"kitchen\"/></state></result>",false));
}
