{
  try {
    final DataInputStream dis=new DataInputStream(socket.getInputStream());
    final PrintOutput out=new PrintOutput(new BufferedOutput(socket.getOutputStream()));
    final String us=dis.readUTF();
    final String pw=dis.readUTF();
    context.user=context.users.get(us,pw);
    final boolean ok=context.user != null;
    new DataOutputStream(out).writeUTF(ok ? "" : "Login failed.");
    out.flush();
    if (info)     Main.outln(this + (ok ? " Login: " : " Failed: ") + us);
    if (!ok)     return;
    while (true) {
      String in=null;
      try {
        in=dis.readUTF();
      }
 catch (      final IOException ex) {
        exit();
        break;
      }
      final Performance perf=new Performance();
      Process proc=null;
      try {
        proc=new CommandParser(in,context,true).parse()[0];
        if (proc instanceof IntOutput || proc instanceof IntInfo) {
          if (proc instanceof IntOutput) {
            core.output(out);
            out.write(new byte[IO.BLOCKSIZE]);
          }
 else {
            String inf=core.info();
            if (inf.equals(PROGERR))             inf=SERVERTIME;
            new DataOutputStream(out).writeUTF(inf);
          }
          out.flush();
        }
 else {
          core=proc;
          startTimer(proc);
          send(out,proc.execute(context));
          stopTimer();
          if (proc instanceof IntStop || proc instanceof Exit) {
            exit();
            if (proc instanceof IntStop)             server.quit(false);
            break;
          }
        }
      }
 catch (      final QueryException ex) {
        proc=new Process(0){
        }
;
        proc.error(ex.extended());
        core=proc;
        send(out,false);
      }
      if (info)       Main.outln(this + " " + in+ ": "+ perf.getTimer());
    }
    if (info)     Main.outln(this + " Logout: " + context.user);
  }
 catch (  final IOException ex) {
    Main.error(ex,false);
  }
}
