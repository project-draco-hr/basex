{
  parseOptions(http);
  String enc=http.req.getCharacterEncoding();
  if (enc == null)   enc=Token.UTF8;
  final byte[] in=new NewlineInput(http.req.getInputStream()).encoding(enc).content();
  validate(in);
  final Context ctx=http.context();
  DBNode doc;
  try {
    doc=new DBNode(new IOContent(in),ctx.prop);
  }
 catch (  final IOException ex) {
    throw HTTPErr.BAD_REQUEST_X.thrw(ex);
  }
  final SerializerProp sp=new SerializerProp();
  QueryProcessor qp;
  RESTCode code;
  try {
    final TokenBuilder ser=new TokenBuilder();
    qp=new QueryProcessor("*/*:parameter",ctx).context(doc);
    for (    final Item param : qp.value()) {
      final String name=value("data(@name)",param,ctx);
      final String value=value("data(@value)",param,ctx);
      if (sp.get(name) != null) {
        ser.add(name).add('=').add(value).add(',');
      }
 else       if (name.equals(WRAP)) {
        wrap(value,http);
      }
 else {
        HTTPErr.UNKNOWN_PARAM_X.thrw(name);
      }
    }
    http.serialization=ser.toString();
    qp=new QueryProcessor("*/*:option",ctx).context(doc);
    for (    final Item it : qp.value()) {
      final String name=value("data(@name)",it,ctx);
      final String value=value("data(@value)",it,ctx);
      http.session().execute(new Set(name,value));
    }
    final Map<String,String[]> vars=new HashMap<String,String[]>();
    qp=new QueryProcessor("*/*:variable",ctx).context(doc);
    for (    final Item it : qp.value()) {
      final String name=value("data(@name)",it,ctx);
      final String value=value("data(@value)",it,ctx);
      final String type=value("data(@type)",it,ctx);
      vars.put(name,new String[]{value,type});
    }
    byte[] item=null;
    qp=new QueryProcessor("*/*:context/node()",ctx).context(doc);
    for (    final Item it : qp.value()) {
      if (item != null)       HTTPErr.MULTIPLE_CONTEXT_X.thrw();
      final Item n=DataBuilder.stripNS((ANode)it,RESTURI,ctx);
      final ArrayOutput ao=new ArrayOutput();
      n.serialize(Serializer.get(ao));
      item=ao.toArray();
    }
    final String request=value("local-name(*)",doc,ctx);
    final String text=value("*/*:text/text()",doc,ctx);
    if (request.equals(COMMAND)) {
      code=new RESTCommand(text);
    }
 else     if (request.equals(RUN)) {
      code=new RESTRun(text,vars,item);
    }
 else {
      code=new RESTQuery(text,vars,item);
    }
    code.run(http);
  }
 catch (  final QueryException ex) {
    HTTPErr.BAD_REQUEST_X.thrw(ex);
  }
}
