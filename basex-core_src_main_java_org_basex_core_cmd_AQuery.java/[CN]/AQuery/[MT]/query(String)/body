{
  final Performance p=new Performance();
  String err;
  if (cause != null) {
    err=Util.message(cause);
  }
 else {
    try {
      final boolean serial=options.get(MainOptions.SERIALIZE);
      qi.runs=Math.max(1,options.get(MainOptions.RUNS));
      long hits=0;
      for (int r=0; r < qi.runs; ++r) {
        if (r != 0)         qp=null;
        qp(query,context);
        qp.http(http);
        for (        final String name : vars.keySet()) {
          final String[] value=vars.get(name);
          if (name == null)           qp.context(value[0],value[1]);
 else           qp.bind(name,value[0],value[1]);
        }
        qp.parse();
        qi.pars+=p.time();
        if (r == 0)         plan(false);
        qp.compile();
        qi.cmpl+=p.time();
        if (r == 0)         plan(true);
        final PrintOutput po=r == 0 && serial ? out : new NullOutput();
        final Serializer ser;
        if (options.get(MainOptions.CACHEQUERY)) {
          result=qp.execute();
          qi.evlt+=p.time();
          ser=qp.getSerializer(po);
          result.serialize(ser);
          hits=result.size();
        }
 else {
          hits=0;
          final Iter ir=qp.iter();
          qi.evlt+=p.time();
          Item it=ir.next();
          ser=qp.getSerializer(po);
          while (it != null) {
            checkStop();
            ser.serialize(it);
            it=ir.next();
            ++hits;
          }
        }
        ser.close();
        qp.close();
        qi.srlz+=p.time();
      }
      out.flush();
      if (goptions.get(GlobalOptions.GLOBALLOCK) && qp.updating)       qi.readLocked=qi.writeLocked=null;
      return info(qi.toString(qp,out,hits,options.get(MainOptions.QUERYINFO)));
    }
 catch (    final QueryException ex) {
      cause=ex;
      err=Util.message(ex);
    }
catch (    final IOException ex) {
      err=Util.message(ex);
    }
catch (    final ProcException ex) {
      err=INTERRUPTED;
    }
catch (    final StackOverflowError ex) {
      Util.debug(ex);
      err=BASX_STACKOVERFLOW.desc;
    }
catch (    final RuntimeException ex) {
      extError("");
      Util.debug(info());
      throw ex;
    }
 finally {
      if (qp != null)       qp.close();
    }
  }
  return extError(err);
}
