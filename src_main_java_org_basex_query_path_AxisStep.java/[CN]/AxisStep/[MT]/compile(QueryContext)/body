{
  if (!test.compile(ctx))   return Empty.SEQ;
  final Data data=ctx.data();
  ctx.leaf=data != null && test.mode == Mode.NAME && test.type != NodeType.ATT && axis.down && data.meta.uptodate && data.nspaces.size() == 0;
  if (ctx.leaf) {
    final Stats s=data.tagindex.stat(data.tagindex.id(((NameTest)test).ln));
    ctx.leaf=s != null && s.isLeaf();
  }
  final Type ct=ctx.value != null ? ctx.value.type : null;
  if (ct == NodeType.DOC)   ctx.value.type=NodeType.NOD;
  final Expr e=super.compile(ctx);
  if (ct == NodeType.DOC)   ctx.value.type=ct;
  ctx.leaf=false;
  if (e != this || e instanceof IterStep)   return e;
  if (!uses(Use.POS))   return new IterStep(info,axis,test,preds);
  if (this instanceof IterPosStep)   return this;
  return useIterator() ? new IterPosStep(this) : this;
}
