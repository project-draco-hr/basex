{
  final Map<String,String[]> vars=new HashMap<String,String[]>();
  String operation=null;
  String input=null;
  byte[] item=null;
  final Map<String,String[]> params=params(ctx);
  final TokenBuilder ser=new TokenBuilder();
  final SerializerProp sp=new SerializerProp();
  for (  final Entry<String,String[]> param : params.entrySet()) {
    final String key=param.getKey();
    final String[] vals=param.getValue();
    final String val=vals[0];
    if (Token.eqic(key,COMMAND,QUERY,RUN)) {
      if (operation != null || vals.length > 1)       throw new RESTException(SC_BAD_REQUEST,ERR_ONLYONE);
      operation=key;
      input=val;
    }
 else     if (key.equalsIgnoreCase(WRAP)) {
      wrap(val,ctx);
    }
 else     if (key.equalsIgnoreCase(CONTEXT)) {
      item=Token.token(val);
    }
 else     if (sp.get(key) != null) {
      for (      final String v : vals)       ser.add(key).add('=').add(v).add(',');
    }
 else     if (!parseOption(ctx,param)) {
      vars.put(key,new String[]{val});
    }
  }
  ctx.serialization=ser.toString();
  final RESTCode code;
  if (operation == null) {
    code=new RESTRetrieve(input,vars,item);
  }
 else   if (operation.equals(QUERY)) {
    code=new RESTQuery(input,vars,item);
  }
 else   if (operation.equals(RUN)) {
    code=new RESTRun(input,vars,item);
  }
 else {
    code=new RESTCommand(input);
  }
  code.run(ctx);
}
