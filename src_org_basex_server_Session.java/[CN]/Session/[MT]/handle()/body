{
  final Performance perf=new Performance();
  final InetAddress addr=socket.getInetAddress();
  final String ha=addr.getHostAddress();
  final int sp=socket.getPort();
  dis=new DataInputStream(socket.getInputStream());
  out=new PrintOutput(new BufferedOutput(socket.getOutputStream()));
  final int port=socket.getPort();
  if (info)   BaseX.outln("[%:%] Login: client '%'.",ha,port,clientId);
  while (true) {
    final String in=getMessage();
    if (in == null) {
      stop(false);
      break;
    }
    if (info)     BaseX.outln("[%:%] %",ha,port,in);
    Process proc=null;
    try {
      proc=new CommandParser(in,context,true).parse()[0];
    }
 catch (    final QueryException ex) {
      proc=new Process(0){
      }
;
      proc.error(ex.extended());
      core=proc;
      send(false);
      continue;
    }
    if (proc instanceof IntStop || proc instanceof Exit) {
      send(true);
      stop(true);
      if (proc instanceof IntStop)       bxs.stop();
      break;
    }
 else     if (proc instanceof IntOutput || proc instanceof IntInfo) {
      if (core == null) {
        out.print(BaseX.info(SERVERTIME));
      }
 else {
        if (proc instanceof IntOutput) {
          core.output(out);
          out.write(new byte[IO.BLOCKSIZE]);
        }
 else {
          new DataOutputStream(out).writeUTF(core.info());
        }
        out.flush();
      }
    }
 else {
      core=proc;
      timeout(proc);
      send(proc.execute(context));
      if (proc.info().equals(PROGERR))       proc.error(SERVERTIME);
      timeout.interrupt();
    }
    if (info)     BaseX.outln("[%:%] %",ha,sp,perf.getTimer());
  }
  if (info)   BaseX.outln("[%:%] Logout: client '%'.",ha,port,clientId);
}
