{
  final Performance perf=new Performance();
  final InetAddress addr=socket.getInetAddress();
  final String ha=addr.getHostAddress();
  final int sp=socket.getPort();
  DataInputStream dis=new DataInputStream(socket.getInputStream());
  DataOutputStream dos=new DataOutputStream(socket.getOutputStream());
  PrintOutput out=new PrintOutput(new BufferedOutput(socket.getOutputStream()));
  final int port=socket.getPort();
  String in;
  while (running) {
    in=getMessage(dis).trim();
    if (verbose)     BaseX.outln("[%:%] %",ha,port,in);
    Process pr=null;
    try {
      pr=new CommandParser(in).parse()[0];
    }
 catch (    final QueryException ex) {
      pr=new Process(0){
      }
;
      pr.error(ex.extended());
      core=pr;
      send(-sp,dos);
      return;
    }
    if (pr instanceof Exit) {
      send(0,dos);
      running=false;
      break;
    }
    Process proc=pr;
    if (proc instanceof GetResult || proc instanceof GetInfo) {
      Process c=core;
      if (c == null) {
        out.print(BaseX.info(SERVERTIME,Prop.timeout));
      }
 else       if (proc instanceof GetResult) {
        c.output(out);
      }
 else       if (proc instanceof GetInfo) {
        c.info(out);
        out.write(0);
      }
      out.flush();
    }
 else {
      core=proc;
      send(proc.execute(context) ? sp : -sp,dos);
    }
    if (verbose)     BaseX.outln("[%:%] %",ha,sp,perf.getTimer());
  }
  stop();
}
