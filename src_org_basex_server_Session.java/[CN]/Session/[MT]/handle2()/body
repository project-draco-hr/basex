{
  DataInputStream dis=new DataInputStream(socket.getInputStream());
  DataOutputStream dos=new DataOutputStream(socket.getOutputStream());
  PrintOutput out=new PrintOutput(new BufferedOutput(socket.getOutputStream()));
  final int sp=socket.getPort();
  String in;
  while ((in=getMessage(dis).trim()) != null) {
    if (in.equals("exit")) {
      BaseX.outln("Client " + clientId + " has logged out.");
      break;
    }
    Process pr=null;
    try {
      pr=new CommandParser(in).parse()[0];
    }
 catch (    final QueryException ex) {
      pr=new Process(0){
      }
;
      pr.error(ex.extended());
      core=pr;
      send(-sp,dos);
      return;
    }
    Process proc=pr;
    if (proc instanceof GetResult || proc instanceof GetInfo) {
      Process c=core;
      if (c == null) {
        out.print(BaseX.info(SERVERTIME,Prop.timeout));
      }
 else       if (proc instanceof GetResult) {
        c.output(out);
      }
 else       if (proc instanceof GetInfo) {
        c.info(out);
      }
      out.flush();
    }
 else {
      core=proc;
      send(proc.execute(context) ? sp : -sp,dos);
    }
  }
  dis.close();
  socket.close();
}
