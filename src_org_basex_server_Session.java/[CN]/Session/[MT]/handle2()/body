{
  DataInputStream dis=new DataInputStream(socket.getInputStream());
  final int sp=socket.getPort();
  System.out.println(socket);
  String in;
  while ((in=dis.readUTF()) != null) {
    String into=in.trim();
    if (into.equals("exit")) {
      System.out.println("Client " + clientId + " has logged out.");
      break;
    }
    Process pr=null;
    try {
      pr=new CommandParser(into).parse()[0];
    }
 catch (    final QueryException ex) {
      pr=new Process(0){
      }
;
      pr.error(ex.extended());
      core=pr;
      send(-sp);
    }
    Process proc=pr;
    if (proc instanceof GetResult || proc instanceof GetInfo) {
      Process c=core;
      PrintOutput out=new PrintOutput(new BufferedOutput(socket.getOutputStream()));
      if (c == null) {
        out.print(BaseX.info(SERVERTIME,Prop.timeout));
      }
 else       if (proc instanceof GetResult) {
        c.output(out);
      }
 else       if (proc instanceof GetInfo) {
        c.info(out);
      }
      out.flush();
    }
 else {
      core=proc;
      send(proc.execute(context) ? sp : -sp);
    }
  }
  System.out.println("CLOSED");
  socket.close();
}
