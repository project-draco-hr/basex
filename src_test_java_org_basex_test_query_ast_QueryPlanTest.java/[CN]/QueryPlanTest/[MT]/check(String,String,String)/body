{
  final QueryProcessor qp=new QueryProcessor(qu,CTX);
  try {
    qp.compile();
    final Data plan=CreateDB.mainMem(new Parser(""){
      @Override public void parse(      final Builder build) throws IOException {
        build.startDoc(QueryText.PLAN);
        qp.plan(new BuilderSerializer(build));
        build.endDoc();
      }
    }
,CTX);
    if (res != null)     assertEquals("Query result:",res,qp.execute().toString());
    CTX.openDB(plan);
    for (    final String p : pr) {
      if (!new XQuery(p).execute(CTX).equals("true"))       fail(p + ":" + NL+ qp.ctx.root+ NL+ new XQuery("/").execute(CTX));
    }
  }
 catch (  final Exception ex) {
    throw new Error(ex.getMessage(),ex);
  }
 finally {
    try {
      qp.close();
    }
 catch (    final QueryException ex) {
    }
  }
}
