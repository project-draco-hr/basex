{
  log.write(this,"LOGIN " + context.user.name,OK);
  String input=null;
  running=true;
  try {
    while (running) {
      try {
        final byte b=in.readByte();
        final ServerCmd sc=ServerCmd.get(b);
        if (sc == CREATE) {
          create();
          continue;
        }
        if (sc == ADD) {
          add();
          continue;
        }
        if (sc == ATTACH) {
          attach();
          continue;
        }
        if (sc == DETACH) {
          detach();
          continue;
        }
        if (sc != CMD) {
          query(sc);
          continue;
        }
        input=new ByteList().add(b).add(in.content().toArray()).toString();
      }
 catch (      final IOException ex) {
        exit();
        break;
      }
      final Performance perf=new Performance();
      cmd=null;
      try {
        cmd=new CommandParser(input,context).parseSingle();
      }
 catch (      final QueryException ex) {
        final String msg=ex.getMessage();
        log.write(this,input,INFOERROR + msg);
        out.write(0);
        out.writeString(msg);
        send(false);
        continue;
      }
      if (cmd instanceof Exit) {
        exit();
        running=false;
        break;
      }
      cmd.startTimeout(context.prop.num(Prop.TIMEOUT));
      final String c=cmd.toString().replace('\r',' ').replace('\n',' ');
      log.write(this,c);
      boolean ok=true;
      String info=null;
      try {
        cmd.execute(context,out);
        info=cmd.info();
      }
 catch (      final BaseXException ex) {
        ok=false;
        info=ex.getMessage();
        if (info.startsWith(PROGERR))         info=SERVERTIMEOUT;
      }
      cmd.stopTimeout();
      out.write(0);
      out.writeString(info);
      send(ok);
      log.write(this,ok ? OK : INFOERROR + info,perf);
    }
    if (!running)     log.write(this,"LOGOUT " + context.user.name,OK);
  }
 catch (  final IOException ex) {
    log.write(this,input,INFOERROR + ex.getMessage());
    Util.stack(ex);
    exit();
  }
}
