{
  view.refreshControls(false);
  final byte[] in=getText();
  final boolean eq=eq(in,last);
  if (eq && action == Action.CHECK)   return;
  last=in;
  final String path=file.path();
  final boolean xquery=file.hasSuffix(IO.XQSUFFIXES) || !path.contains(".");
  script=!xquery && file.hasSuffix(IO.BXSSUFFIX);
  String input=string(in);
  if (action == Action.EXECUTE && script) {
    gui.execute(true,new Execute(input));
  }
 else   if (xquery || action == Action.EXECUTE) {
    if (input.isEmpty())     input="()";
    final boolean lib=QueryProcessor.isLibrary(string(in));
    if (!lib && (action == Action.EXECUTE || gui.gopts.bool(GUIOptions.EXECRT))) {
      gui.execute(true,new XQuery(input));
    }
 else {
      gui.context.options.string(MainOptions.QUERYPATH,path);
      final QueryContext qc=new QueryContext(gui.context);
      try {
        if (lib)         qc.parseLibrary(input,null);
 else         qc.parseMain(input,null);
        view.info(OK,true,false);
      }
 catch (      final QueryException ex) {
        view.info(Util.message(ex),false,false);
      }
 finally {
        qc.close();
      }
    }
  }
 else   if (script || file.hasSuffix(IO.XMLSUFFIXES) || file.hasSuffix(IO.XSLSUFFIXES)|| file.hasSuffix(IO.HTMLSUFFIXES)) {
    try {
      if (!script || input.trim().startsWith("<"))       new EmptyBuilder(new IOContent(in),gui.context).build();
      if (script)       new CommandParser(input,gui.context).parse();
      view.info(OK,true,false);
    }
 catch (    final Exception ex) {
      view.info(Util.message(ex),false,false);
    }
  }
 else   if (action != Action.CHECK) {
    view.info(OK,true,false);
  }
}
