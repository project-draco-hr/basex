{
  if (!test.optimize(ctx))   return Empty.SEQ;
  for (int p=0; p < preds.length; ++p) {
    Expr pr=Pos.get(OpV.EQ,preds[p],preds[p],info);
    if (pr instanceof CmpG || pr instanceof CmpV) {
      final Cmp cmp=(Cmp)pr;
      if (cmp.exprs[0].isFunction(Function.POSITION) && cmp.exprs[1].isFunction(Function.LAST)) {
        if (cmp instanceof CmpG && ((CmpG)cmp).op == OpG.EQ || cmp instanceof CmpV && ((CmpV)cmp).op == OpV.EQ) {
          ctx.compInfo(OPTWRITE,pr);
          pr=cmp.exprs[1];
        }
      }
    }
    if (pr.isValue()) {
      if (!pr.ebv(ctx,info).bool(info)) {
        ctx.compInfo(OPTREMOVE,this,pr);
        return Empty.SEQ;
      }
      ctx.compInfo(OPTREMOVE,this,pr);
      preds=Array.delete(preds,p--);
    }
 else     if (pr instanceof And && !pr.has(Flag.FCS)) {
      ctx.compInfo(OPTPRED,pr);
      final Expr[] and=((Arr)pr).exprs;
      final int m=and.length - 1;
      final ExprList tmp=new ExprList(preds.length + m);
      for (      final Expr e : Arrays.asList(preds).subList(0,p))       tmp.add(e);
      for (      final Expr a : and) {
        tmp.add(Function.BOOLEAN.get(null,info,a).compEbv(ctx));
      }
      for (      final Expr e : Arrays.asList(preds).subList(p + 1,preds.length))       tmp.add(e);
      preds=tmp.finish();
    }
 else {
      preds[p]=pr;
    }
  }
  if (!has(Flag.FCS))   return new IterStep(info,axis,test,preds);
  return this instanceof IterPosStep || !posIterator() ? this : new IterPosStep(this);
}
