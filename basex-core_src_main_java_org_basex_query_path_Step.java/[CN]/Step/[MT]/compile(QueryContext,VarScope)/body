{
  if (!test.compile(ctx))   return Empty.SEQ;
  final Type ct=ctx.value != null ? ctx.value.type : null;
  final boolean leaf=ctx.leaf;
  ctx.leaf=false;
  try {
    final Data data=ctx.data();
    if (data != null && test.mode == Mode.LN && test.type != NodeType.ATT && axis.down && data.meta.uptodate && data.nspaces.size() == 0) {
      final Stats s=data.tagindex.stat(data.tagindex.id(((NameTest)test).ln));
      ctx.leaf=s != null && s.isLeaf();
    }
    if (ct == NodeType.DOC)     ctx.value.type=NodeType.NOD;
    final Expr e=super.compile(ctx,scp);
    if (e != this || e instanceof IterStep)     return e;
  }
  finally {
    if (ct == NodeType.DOC)     ctx.value.type=ct;
    ctx.leaf=leaf;
  }
  if (!has(Flag.FCS))   return new IterStep(info,axis,test,preds);
  return this instanceof IterPosStep || !useIterator() ? this : new IterPosStep(this);
}
