{
  if (root != null)   root=root.compile(qc,scp);
  if (steps.length == 0)   return root == null ? new ContextValue(info) : root;
  final Value init=qc.value, cv=initial(qc);
  qc.value=cv;
  final boolean doc=cv != null && cv.type == NodeType.DOC;
  try {
    final int sl=steps.length;
    for (int s=0; s < sl; s++) {
      final Expr step=steps[s];
      final boolean as=step instanceof Step;
      if (as && s == 0 && doc)       cv.type=NodeType.NOD;
      try {
        steps[s]=step.compile(qc,scp);
      }
 catch (      final QueryException ex) {
        steps[s]=FnError.get(ex,seqType,scp.sc);
      }
      if (!as)       qc.value=null;
    }
  }
  finally {
    if (doc)     cv.type=NodeType.DOC;
    qc.value=init;
  }
  return optimize(qc,scp);
}
