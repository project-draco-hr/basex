{
  final CountDownLatch sync=new CountDownLatch(1), test1=new CountDownLatch(1), test2=new CountDownLatch(1);
  final Integer[] obj1=new Integer[]{1,2,3};
  final Integer[] obj2=new Integer[]{obj1[2],obj1[0]};
  final Integer[] obj0=new Integer[]{obj1[1]};
  final LockTester<Integer> thread0=new LockTester<Integer>(null,true,obj0,sync);
  final LockTester<Integer> thread1=new LockTester<Integer>(sync,true,obj1,test1);
  final LockTester<Integer> thread2=new LockTester<Integer>(sync,true,obj2,test2);
  thread0.start();
  thread1.start();
  thread2.start();
  Thread.sleep(WAIT);
  thread0.release();
  assertTrue("One of the threads should be able to fetch its second lock.",test1.await(WAIT,TimeUnit.MILLISECONDS) ^ test2.await(WAIT,TimeUnit.MILLISECONDS));
  boolean first=false;
  if (test1.await(0,TimeUnit.MILLISECONDS)) {
    thread1.release();
    first=true;
  }
  if (test2.await(0,TimeUnit.MILLISECONDS))   thread2.release();
  assertTrue("Both threads should be finished now.",test1.await(WAIT,TimeUnit.MILLISECONDS) && test2.await(WAIT,TimeUnit.MILLISECONDS));
  if (first)   thread2.release();
 else   thread1.release();
}
