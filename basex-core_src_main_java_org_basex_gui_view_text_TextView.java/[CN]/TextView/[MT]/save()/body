{
  final BaseXFileChooser fc=new BaseXFileChooser(SAVE_AS,gui.gopts.get(GUIOptions.WORKPATH),gui).suffix(IO.XMLSUFFIX);
  final IO file=fc.select(Mode.FSAVE);
  if (file == null)   return;
  gui.gopts.set(GUIOptions.WORKPATH,file.path());
  PrintOutput out=null;
  gui.cursor(CURSORWAIT,true);
  final Options opts=gui.context.options;
  final int mh=opts.num(Options.MAXHITS);
  opts.set(Options.MAXHITS,-1);
  opts.set(Options.CACHEQUERY,false);
  try {
    out=new PrintOutput(file.toString());
    if (cmd != null) {
      cmd.execute(gui.context,out);
    }
 else     if (ns != null) {
      ns.serialize(Serializer.get(out));
    }
 else {
      final byte[] txt=text.getText();
      for (      final byte t : txt)       if (t < 0 || t > ' ' || ws(t))       out.write(t);
    }
  }
 catch (  final IOException ex) {
    BaseXDialog.error(gui,FILE_NOT_SAVED);
  }
 finally {
    if (out != null)     try {
      out.close();
    }
 catch (    final IOException ignored) {
    }
    opts.set(Options.MAXHITS,mh);
    opts.set(Options.CACHEQUERY,true);
    gui.cursor(CURSORARROW,true);
  }
}
