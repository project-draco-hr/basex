{
  if (compiled)   return this;
  compiled=true;
  checkUpdating();
  for (  final Entry<Var,Expr> e : global.entrySet()) {
    final Expr bound=e.getValue().compile(qc,scp);
    e.setValue(bound);
    e.getKey().refineType(bound.seqType(),qc);
  }
  try {
    expr=expr.compile(qc,scope);
  }
 catch (  final QueryException qe) {
    expr=FnError.get(qe,type != null ? type : expr.seqType(),scp.sc);
  }
 finally {
    scope.cleanUp(this);
  }
  expr.markTailCalls(qc);
  return optimize(qc,scp);
}
