{
  final Prop pr=p.prop;
  if (pr.is(Prop.MAINMEM))   return new MemBuilder(p).build(db);
  if (ctx.pinned(db) || p.prop.dbpath(db + ".tmp").exists())   throw new IOException(DBINUSE);
  final Builder builder=new DiskBuilder(p);
  final String tmp=db + ".tmp";
  try {
    final Data data=builder.build(tmp);
    if (data.meta.txtindex)     data.setIndex(Type.TXT,new ValueBuilder(data,true).build());
    if (data.meta.atvindex)     data.setIndex(Type.ATV,new ValueBuilder(data,false).build());
    if (data.meta.ftxindex)     data.setIndex(Type.FTX,data.meta.ftfz ? new FTFuzzyBuilder(data,pr).build() : new FTTrieBuilder(data,pr).build());
    data.close();
    if (!move(db,pr))     throw new IOException();
  }
 catch (  final IOException ex) {
    try {
      builder.close();
    }
 catch (    final IOException exx) {
      Main.debug(exx);
    }
    DropDB.drop(tmp,pr);
    throw ex;
  }
  return Open.open(ctx,db);
}
