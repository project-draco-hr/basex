{
  final boolean frag=p.node instanceof FNode;
  if (t && (frag || !refs.contains(((DBNode)p.node).data)))   Err.or(UPWRONGTRG,p.node);
  final Data d=frag ? dataDummy : ((DBNode)p.node).data;
  Primitives prim=primitives.get(d);
  if (prim == null) {
    if (!frag && ctx.context.perm(User.WRITE,d.meta) != -1)     throw new QueryException(Main.info(PERMNO,CmdPerm.WRITE));
    prim=frag ? new FragmentPrimitives() : new DBPrimitives(d);
    primitives.put(d,prim);
  }
  prim.add(p);
}
