{
  final String type=conn.getContentType();
  final ValueBuilder payloads=new ValueBuilder();
  final boolean s=status != null && Bln.parse(status,info);
  final FElem body;
  InputStream is=conn.getErrorStream();
  final byte[] cType;
  if (is == null) {
    cType=ctype == null ? token(HTTPPayload.contentType(type)) : ctype;
    is=conn.getInputStream();
  }
 else {
    cType=token(MimeTypes.TEXT_PLAIN);
  }
  if (startsWith(cType,MULTIPART)) {
    final byte[] boundary=HTTPPayload.boundary(type);
    if (boundary == null)     HC_REQ.thrw(info,"No separation boundary specified");
    body=new FElem(Q_MULTIPART).add(MEDIA_TYPE,cType).add(BOUNDARY,boundary);
    final ANodeList list=extractParts(is,s,payloads,concat(DASHES,boundary));
    for (    final ANode node : list)     body.add(node);
  }
 else {
    body=createBody(cType);
    if (!s) {
      final byte[] payload=extractPayload(is,cType,HTTPPayload.charset(type));
      payloads.add(interpretPayload(payload,cType));
    }
  }
  final FElem responseEl=new FElem(Q_RESPONSE).declareNS();
  responseEl.add(STATUS,token(conn.getResponseCode()));
  responseEl.add(MESSAGE,token(conn.getResponseMessage()));
  for (  final String header : conn.getHeaderFields().keySet()) {
    if (header != null) {
      final FElem hdr=new FElem(Q_HEADER);
      hdr.add(NAME,token(header));
      hdr.add(VALUE,token(conn.getHeaderField(header)));
      responseEl.add(hdr);
    }
  }
  responseEl.add(body);
  return new ValueBuilder().add(responseEl).add(payloads.value());
}
