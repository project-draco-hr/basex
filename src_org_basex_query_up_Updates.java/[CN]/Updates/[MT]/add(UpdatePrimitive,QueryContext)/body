{
  final boolean frag=p.node instanceof FNode;
  if (t && (frag || !refs.contains(((DBNode)p.node).data)))   Err.or(UPNOTCOPIED,p.node);
  if (frag && fdata == null)   fdata=new MemData(ctx.context.prop);
  final Data d=frag ? fdata : ((DBNode)p.node).data;
  Primitives prim=primitives.get(d);
  if (prim == null) {
    if (!t && !frag && ctx.context.perm(User.WRITE,d.meta) != -1)     throw new QueryException(Main.info(PERMNO,CmdPerm.WRITE));
    prim=frag ? new FragPrimitives() : new DBPrimitives(d);
    primitives.put(d,prim);
  }
  prim.add(p);
}
