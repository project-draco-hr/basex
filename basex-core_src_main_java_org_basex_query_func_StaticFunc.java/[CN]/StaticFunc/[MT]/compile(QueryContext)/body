{
  if (compiled)   return;
  compiling=compiled=true;
  final Value cv=qc.value;
  qc.value=null;
  try {
    expr=expr.compile(qc,scope);
    if (declType != null) {
      if ((declType.type == AtomType.BLN || declType.type == AtomType.FLT || declType.type == AtomType.DBL || declType.type == AtomType.QNM || declType.type == AtomType.URI) && declType.eq(expr.seqType())) {
        qc.compInfo(OPTCAST,declType);
      }
 else {
        expr=new TypeCheck(sc,info,expr,declType,true).optimize(qc,scope);
      }
    }
  }
 catch (  final QueryException qe) {
    expr=FnError.get(qe,expr.seqType());
  }
 finally {
    scope.cleanUp(this);
    qc.value=cv;
  }
  expr.markTailCalls(qc);
  compiling=false;
}
