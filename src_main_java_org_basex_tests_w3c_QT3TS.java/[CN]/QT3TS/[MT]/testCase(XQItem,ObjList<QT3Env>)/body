{
  if (!supported(test))   return;
  if (++total % 500 == 0)   Util.out(".");
  final String name=string("@name",test);
  if (!name.startsWith(single))   return;
  final XQuery qexp=new XQuery("*:result/*[1]",ctx).context(test);
  final XQValue expected=qexp.value();
  final XQuery q=new XQuery("*:dependency[@type='spec']" + "[matches(@value,'(XQ10|XP20)([^+]|$)')]",ctx);
  if (q.context(test).next() != null)   ctx.prop.set(Prop.XQUERY3,false);
  q.close();
  QT3Env e=null;
  final XQuery qenv=new XQuery("*:environment[*]",ctx).context(test);
  final XQValue ienv=qenv.next();
  if (ienv != null)   e=new QT3Env(ctx,ienv);
  qenv.close();
  String b=base;
  if (e == null) {
    final String env=string("*:environment/@ref",test);
    if (!env.isEmpty()) {
      e=envs(envs,env);
      if (e == null) {
        e=envs(genvs,env);
        b=null;
      }
      if (e == null)       Util.errln("%: environment '%' not found.",name,env);
    }
  }
  final Performance perf=new Performance();
  final String string=string("data(*:test)",test);
  final XQuery query=new XQuery(string,ctx);
  if (b != null)   query.baseURI(b);
  final XQuery qmod=new XQuery("for $m in *:module return ($m/@uri, $m/@file)",ctx).context(test);
  while (true) {
    final XQItem uri=qmod.next();
    if (uri == null)     break;
    final XQItem file=qmod.next();
    query.addModule(uri.getString(),base + file.getString());
  }
  final QT3Result result=new QT3Result();
  try {
    if (e != null) {
      for (      final HashMap<String,String> ns : e.namespaces) {
        query.namespace(ns.get(PREFIX),ns.get(URI));
      }
      for (      final HashMap<String,String> par : e.params) {
        query.bind(par.get(NNAME),new XQuery(par.get(SELECT),ctx).value());
      }
      for (      final HashMap<String,String> src : e.sources) {
        query.addDocument(src.get(URI),src.get(FILE));
        final String role=src.get(ROLE);
        if (role == null)         continue;
        final Object call=Function.DOC.get(null,Str.get(src.get(FILE)));
        if (role.equals("."))         query.context(call);
 else         query.bind(role,call);
      }
      query.addCollection(e.collURI,e.collSources.toArray());
      if (e.collContext) {
        query.context(Function.COLL.get(null,Str.get(e.collURI)));
      }
      if (e.baseURI != null)       query.baseURI(e.baseURI);
    }
    result.value=query.value();
  }
 catch (  final XQException ex) {
    result.exc=ex;
  }
catch (  final Throwable ex) {
    result.error=ex;
    Util.errln("Query: " + name);
    ex.printStackTrace();
  }
  final long time=perf.getTime() / 1000000;
  if (verbose)   Util.outln(name + ": " + time+ " ms");
  ctx.prop.set(Prop.XQUERY3,true);
  final String msg=test(result,expected);
  final TokenBuilder tmp=new TokenBuilder();
  tmp.add(name).add(NL);
  tmp.add(norm(string)).add(NL);
  boolean err=result.value == null;
  String res;
  try {
    res=result.error != null ? result.error.toString() : result.exc != null ? result.exc.getCode() + ": " + result.exc.getLocalizedMessage() : string("serialize(., map { 'indent' := 'no' })",result.value);
  }
 catch (  final XQException ex) {
    res=ex.getCode() + ": " + ex.getLocalizedMessage();
    err=true;
  }
  tmp.add(err ? "Error : " : "Result: ").add(norm(res)).add(NL);
  if (msg == null) {
    tmp.add(NL);
    right.add(tmp.finish());
    correct++;
  }
 else {
    tmp.add("Expect: " + norm(msg)).add(NL).add(NL);
    ;
    wrong.add(tmp.finish());
  }
  query.close();
  qexp.close();
}
