{
  final MapRect l=view.layout.layout;
  l.x=(int)scale * l.x;
  l.y=(int)scale * l.y;
  l.w=(int)scale * l.w;
  l.h=(int)scale * l.h;
  final int ww=view.getWidth();
  final int hh=view.getWidth();
  final Data data=view.gui.context.data();
  final int fsz=prop.num(GUIProp.FONTSIZE);
  final int off=prop.num(GUIProp.MAPOFFSETS);
  final int rs=rects.size;
  for (int ri=0; ri < rs; ++ri) {
    final MapRect r=rects.get(ri);
    final int pre=r.pre;
    final int lvl=r.level;
    final boolean full=r.w == ww && r.h == hh;
    Color col=color(rects,ri);
    final boolean mark=col != null;
    r.pos=view.gui.context.marked.ftpos != null ? view.gui.context.marked.ftpos.get(data,pre) : null;
    g.setColor(mark ? col : GUIConstants.color(lvl));
    if (r.w < l.x + l.w || r.h < l.y + l.h || off < 2 || ViewData.leaf(prop,data,pre)) {
      g.fillRect(r.x,r.y,r.w,r.h);
    }
 else {
      g.fillRect(r.x,r.y,l.x,r.h);
      g.fillRect(r.x,r.y,r.w,l.y);
      g.fillRect(r.x + r.w - l.w,r.y,l.w,r.h);
      g.fillRect(r.x,r.y + r.h - l.h,r.w,l.h);
    }
    if (!full) {
      col=mark ? GUIConstants.colormark3 : GUIConstants.color(lvl + 2);
      g.setColor(col);
      g.drawRect(r.x,r.y,r.w,r.h);
      col=mark ? GUIConstants.colormark4 : GUIConstants.color(Math.max(0,lvl - 2));
      g.setColor(col);
      g.drawLine(r.x + r.w,r.y,r.x + r.w,r.y + r.h);
      g.drawLine(r.x,r.y + r.h,r.x + r.w,r.y + r.h);
    }
    if (r.w <= 3 || r.h < prop.num(GUIProp.FONTSIZE))     continue;
    r.x+=3;
    r.w-=3;
    final int kind=data.kind(pre);
    if (kind == Data.ELEM || kind == Data.DOC) {
      g.setColor(Color.black);
      g.setFont(GUIConstants.font);
      BaseXLayout.chopString(g,ViewData.name(prop,data,pre),r.x,r.y,r.w,fsz);
    }
 else {
      g.setColor(GUIConstants.color(r.level * 2 + 8));
      g.setFont(GUIConstants.mfont);
      final byte[] text=ViewData.content(data,pre,false);
      r.thumb=MapRenderer.calcHeight(g,r,text,fsz) >= r.h;
      if (r.thumb) {
        MapRenderer.drawThumbnails(g,r,text,fsz);
      }
 else {
        MapRenderer.drawText(g,r,text,fsz);
      }
    }
    r.x-=3;
    r.w+=3;
  }
}
