{
  final int dsize=d.meta.size;
  final int buf=dsize;
  buffer(buf);
  int dpre=-1;
  while (++dpre != dsize) {
    final int dkind=d.kind(dpre);
    final int dpar=d.parent(dpre,dkind);
    final int pre=replacePre + dpre;
    final int dis=dpar >= 0 ? dpre - dpar : pre - parent(replacePre,kind(replacePre));
switch (dkind) {
case DOC:
      doc(pre,d.size(dpre,dkind),d.text(dpre,true));
    meta.ndocs++;
  break;
case ELEM:
byte[] nm=d.name(dpre,dkind);
elem(dis,tags.index(nm,null,false),d.attSize(dpre,dkind),d.size(dpre,dkind),ns.uri(nm,true),false);
break;
case TEXT:
case COMM:
case PI:
text(pre,dis,d.text(dpre,true),dkind);
break;
case ATTR:
nm=d.name(dpre,dkind);
attr(pre,dis,atts.index(nm,null,false),d.text(dpre,false),ns.uri(nm,false),false);
break;
}
}
table.replace(replacePre,buffer());
buffer(1);
}
