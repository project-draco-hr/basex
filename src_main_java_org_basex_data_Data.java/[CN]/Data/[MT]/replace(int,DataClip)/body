{
  meta.update();
  final int dsize=clip.size();
  final Data data=clip.data;
  final int rkind=kind(rpre);
  final int rsize=size(rpre,rkind);
  final int rpar=parent(rpre,rkind);
  final int diff=dsize - rsize;
  buffer(dsize);
  resources.replace(rpre,rsize,clip);
  if (meta.updindex) {
    indexDelete(rpre,rsize);
    indexBegin();
  }
  for (int dpre=clip.start; dpre < clip.end; ++dpre) {
    final int dkind=data.kind(dpre);
    final int dpar=data.parent(dpre,dkind);
    final int pre=rpre + dpre;
    final int dis=dpar >= 0 ? dpre - dpar : pre - parent(rpre,rkind);
switch (dkind) {
case DOC:
      doc(pre,data.size(dpre,dkind),data.text(dpre,true));
    meta.ndocs++;
  break;
case ELEM:
byte[] nm=data.name(dpre,dkind);
elem(dis,tagindex.index(nm,null,false),data.attSize(dpre,dkind),data.size(dpre,dkind),nspaces.uri(nm,true),false);
break;
case TEXT:
case COMM:
case PI:
text(pre,dis,data.text(dpre,true),dkind);
break;
case ATTR:
nm=data.name(dpre,dkind);
attr(pre,dis,atnindex.index(nm,null,false),data.text(dpre,false),nspaces.uri(nm,false),false);
break;
}
}
if (meta.updindex) {
indexEnd();
idmap.delete(rpre,id(rpre),-rsize);
idmap.insert(rpre,meta.lastid - dsize + 1,dsize);
}
table.replace(rpre,buffer(),rsize);
buffer(1);
if (diff == 0) return;
int p=rpar;
while (p >= 0) {
final int k=kind(p);
size(p,k,size(p,k) + diff);
p=parent(p,k);
}
if (!cache) updateDist(rpre + dsize,diff);
int dpre=clip.start;
if (data.kind(dpre) == ATTR) {
int d=0;
while (dpre < clip.end && data.kind(dpre++) == ATTR) d++;
if (d > 1) attSize(rpar,kind(rpar),d + 1);
}
}
