{
  final String type=conn.getContentType();
  InputStream is=conn.getErrorStream();
  final boolean error=is != null;
  try {
    if (!error)     is=conn.getInputStream();
  }
 catch (  final IOException ex) {
    Util.debug(ex);
  }
  final ValueBuilder vb=new ValueBuilder();
  final FElem response=new FElem(Q_RESPONSE).declareNS();
  final String msg=conn.getResponseMessage();
  response.add(STATUS,token(conn.getResponseCode()));
  response.add(MESSAGE,msg == null ? "" : msg);
  for (  final String header : conn.getHeaderFields().keySet()) {
    if (header != null) {
      final FElem hdr=new FElem(Q_HEADER);
      hdr.add(NAME,token(header));
      hdr.add(VALUE,conn.getHeaderField(header));
      response.add(hdr);
    }
  }
  vb.add(response);
  if (is != null) {
    try {
      final HttpPayload hp=new HttpPayload(is,body,info,options);
      response.add(hp.parse(error,type,mtype == null ? null : string(mtype)));
      if (body)       vb.add(hp.payloads());
    }
  finally {
      is.close();
    }
  }
  return vb;
}
