{
  if (!hist.active() || control(e) || DELETE.is(e)|| BACKSPACE.is(e)|| ESCAPE.is(e))   return;
  final int caret=editor.caret();
  editor.pos(caret);
  final StringBuilder sb=new StringBuilder(1).append(e.getKeyChar());
  final boolean indent=TAB.is(e) && editor.indent(sb,e.isShiftDown());
  final boolean selected=editor.selected() && !indent;
  if (selected)   editor.delete();
  final int ps=editor.pos();
  final int move=ENTER.is(e) ? editor.enter(sb) : editor.add(sb,selected);
  hist.store(editor.text(),caret,editor.caret());
  if (move != 0)   editor.setCaret(Math.min(editor.size(),ps + move));
  scrollCode.invokeLater(true);
  e.consume();
}
