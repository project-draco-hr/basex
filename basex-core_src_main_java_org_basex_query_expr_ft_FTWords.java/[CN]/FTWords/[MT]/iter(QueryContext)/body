{
  return new FTIter(){
    FTIndexIterator ftiter;
    int len;
    @Override public FTNode next() throws QueryException {
      if (ftiter == null) {
        final FTLexer lexer=new FTLexer(ftt.opt);
        lexer.lserror(qc.context.options.get(MainOptions.LSERROR));
        int t=0;
        for (        final byte[] k : unique(tokens != null ? tokens : tokens(qc))) {
          lexer.init(k);
          if (!lexer.hasNext())           return null;
          int d=0;
          FTIndexIterator ii=null;
          do {
            final byte[] tok=lexer.nextToken();
            t+=tok.length;
            if (ftt.opt.sw != null && ftt.opt.sw.contains(tok)) {
              ++d;
            }
 else {
              final FTIndexIterator ir=lexer.get().length > data.meta.maxlen ? scan(lexer) : (FTIndexIterator)data.iter(lexer);
              ir.pos(++qc.ftPos);
              if (ii == null) {
                ii=ir;
              }
 else {
                ii=FTIndexIterator.intersect(ii,ir,++d);
                d=0;
              }
            }
          }
 while (lexer.hasNext());
          if (ftiter == null) {
            len=t;
            ftiter=ii;
          }
 else           if (mode == FTMode.ALL || mode == FTMode.ALL_WORDS) {
            if (ii.size() == 0)             return null;
            len+=t;
            ftiter=FTIndexIterator.intersect(ftiter,ii,0);
          }
 else {
            if (ii.size() == 0)             continue;
            len=Math.max(t,len);
            ftiter=FTIndexIterator.union(ftiter,ii);
          }
        }
      }
      return ftiter == null || !ftiter.more() ? null : new FTNode(ftiter.matches(),data,ftiter.pre(),len,ftiter.size(),-1);
    }
  }
;
}
