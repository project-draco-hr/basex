{
  final boolean create=context.user.has(Perm.CREATE);
  String name=MetaData.normPath(args[0]);
  if (name == null || name.endsWith("."))   return error(NAME_INVALID_X,args[0]);
  IO io=null;
  if (in == null) {
    io=IO.get(args[1]);
  }
 else   if (in.getSystemId() != null) {
    io=IO.get(in.getSystemId());
  }
 else   if (in.getByteStream() != null) {
    try {
      io=cache();
    }
 catch (    final IOException ex) {
      return error(Util.message(ex));
    }
  }
  if (io != null) {
    if (!io.exists())     return error(FILE_NOT_FOUND_X,create ? io : args[1]);
    if (!name.endsWith("/") && (io.isDir() || io.isArchive()))     name+='/';
  }
  String target="";
  final int s=name.lastIndexOf('/');
  if (s != -1) {
    target=name.substring(0,s);
    name=name.substring(s + 1);
  }
  final Data data=context.data();
  final Parser parser;
  if (io != null) {
    if (!name.isEmpty())     io.name(name);
 else     if (!(io instanceof IOContent))     name=io.name();
    parser=new DirParser(io,prop,data.meta.path);
  }
 else {
    parser=new SAXWrapper(new SAXSource(in),name,context.prop);
  }
  parser.target(target);
  if (name.isEmpty())   return error(NAME_INVALID_X,name);
  final long fl=parser.src.length();
  boolean large=false;
  final Runtime rt=Runtime.getRuntime();
  if (fl > rt.freeMemory() / 3) {
    Performance.gc(2);
    large=fl > rt.freeMemory() / 3;
  }
  if (prop.is(Prop.MAINMEM))   large=false;
  final String db=large ? context.mprop.random(data.meta.name) : name;
  build=large ? new DiskBuilder(db,parser,context) : new MemBuilder(db,parser);
  Data tmp=null;
  try {
    tmp=build.build();
  }
 catch (  final IOException ex) {
    Util.debug(ex);
    return error(Util.message(ex));
  }
 finally {
    try {
      build.close();
    }
 catch (    final IOException e) {
    }
    if (tmp != null)     tmp.close();
    if (large)     DropDB.drop(db,context);
  }
  if (tmp.meta.size > 1) {
    if (lock && !data.startUpdate())     return error(DB_PINNED_X,data.meta.name);
    data.insert(data.meta.size,-1,tmp);
    context.update();
    if (lock)     data.finishUpdate();
  }
  return info(parser.info() + PATH_ADDED_X_X,name,perf);
}
