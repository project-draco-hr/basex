{
  final byte[] data=new byte[IO.BLOCKSIZE];
  for (ANode node; (node=ai.next()) != null; ) {
    final QNm mode=node.qname();
    final boolean dir=mode.eq(E_DIR);
    if (!dir && !mode.eq(E_ENTRY))     ZIPUNKNOWN.thrw(input,mode);
    String name=attribute(node,A_NAME,false);
    String src=attribute(node,A_SRC,false);
    if (src != null)     src=src.replaceAll("\\\\","/");
    if (name == null) {
      if (src == null)       throw ZIPINVALID.thrw(input,node.qname(),A_SRC);
      name=src;
    }
    name=name.replaceAll(".*/","");
    if (dir)     name+='/';
    zos.putNextEntry(new ZipEntry(root + name));
    if (dir) {
      create(zos,node.children(),root + name,zf,ctx);
    }
 else {
      if (src != null) {
        if (!new IOFile(src).exists())         ZIPNOTFOUND.thrw(input,src);
        BufferedInputStream bis=null;
        try {
          bis=new BufferedInputStream(new FileInputStream(src));
          for (int c; (c=bis.read(data)) != -1; )           zos.write(data,0,c);
        }
  finally {
          if (bis != null)           try {
            bis.close();
          }
 catch (          final IOException e) {
          }
        }
      }
 else {
        final AxisIter ch=node.children();
        final String m=attribute(node,A_METHOD,false);
        ANode n=ch.next();
        ZipEntry ze=null;
        if (zf != null && n == null)         ze=zf.getEntry(root + name);
        if (ze != null) {
          final InputStream zis=zf.getInputStream(ze);
          for (int c; (c=zis.read(data)) != -1; )           zos.write(data,0,c);
        }
 else         if (n != null) {
          final boolean hex=M_HEX.equals(m);
          if (hex || M_BASE64.equals(m)) {
            final ByteList bl=new ByteList();
            do             bl.add(n.string());
 while ((n=ch.next()) != null);
            final byte[] bytes=bl.toArray();
            zos.write((hex ? new Hex(bytes) : new B64(bytes)).toJava());
          }
 else {
            try {
              final Serializer ser=Serializer.get(zos,serPar(node,ctx));
              do {
                DataBuilder.stripNS(n,ZIPURI,ctx).serialize(ser);
              }
 while ((n=ch.next()) != null);
              ser.close();
            }
 catch (            final SerializerException ex) {
              throw ex.getCause(input);
            }
          }
        }
      }
      zos.closeEntry();
    }
  }
}
