{
  final Context c=gui.context;
  final Data data=c.data;
  if (data == null)   return;
  if (showAttsChanged())   paintType=PAINT_NEW_INIT;
  if (slimToTextChanged() && paintType == -1)   paintType=PAINT_NEW_WINDOW_SIZE;
  super.paintComponent(g);
  gui.painting=true;
  roots=gui.context.current.list;
  if (roots.length == 0)   return;
  for (int i=0; !showAtts && i < roots.length; ++i) {
    if (data.kind(roots[i]) == Data.ATTR) {
      drawMessage(g,NO_ATTS);
      return;
    }
  }
  smooth(g);
  g.setFont(font);
  fontHeight=g.getFontMetrics().getHeight();
  if (paintType == PAINT_NEW_INIT) {
    sub=new TreeSubtree(data,showAtts);
    tr=new TreeRects();
  }
  if (paintType == PAINT_NEW_INIT || paintType == PAINT_NEW_CONTEXT)   sub.generateBorders(c);
  if ((winChange=windowSizeChanged()) && paintType == -1 || paintType == PAINT_NEW_INIT || paintType == PAINT_NEW_CONTEXT || paintType == PAINT_NEW_WINDOW_SIZE) {
    treedist=tr.generateRects(sub,g,c,wstart,wwidth,slimToText);
    nes=treedist == -1;
    if (!nes) {
      markedImage=null;
      setLevelDistance();
      createNewMainImage();
      if (gui.context.marked.size() > 0)       markNodes();
    }
  }
  if (nes) {
    drawMessage(g,NOT_ENOUGH_SPACE);
    return;
  }
  g.drawImage(treeImage,0,0,wwidth,wheight,this);
  if (selection) {
    if (selectRect != null) {
      final int x=selectRect.w < 0 ? selectRect.x + selectRect.w : selectRect.x;
      final int y=selectRect.h < 0 ? selectRect.y + selectRect.h : selectRect.y;
      final int w=Math.abs(selectRect.w);
      final int h=Math.abs(selectRect.h);
      g.setColor(colormark1);
      g.drawRect(x,y,w,h);
    }
    markNodes();
  }
  if (markedImage != null)   g.drawImage(markedImage,0,0,wwidth,wheight,this);
  inFocus=paintType < 0 && focus();
  if (inFocus && !winChange) {
    if (!refreshedFocus && tr.bigRect(sub,frn,flv)) {
      final int f=getMostSizedNode(data,frn,flv,frect,fpre);
      if (f >= 0)       fpre=f;
    }
    highlightNode(g,frn,flv,frect,fpre,-1,DRAW_HIGHLIGHT);
    if (SHOW_EXTRA_INFO) {
      g.setColor(new Color(0xeeeeee));
      g.fillRect(0,wheight - fontHeight - 6,wwidth,fontHeight + 6);
      final Data d=gui.context.data;
      final int k=d.kind(fpre);
      final int s=d.size(fpre,k);
      final int as=d.attSize(fpre,k);
      g.setColor(Color.BLACK);
      g.drawString("pre: " + fpre + " level: "+ flv+ "  level-size: "+ sub.levelSize(frn,flv)+ "  node-size: "+ (s - as)+ "  node: "+ Token.string(ViewData.tag(gui.gprop,d,fpre)),2,wheight - 6);
    }
    refreshedFocus=false;
  }
  paintType=-1;
  gui.painting=false;
}
