{
  final RuleBasedCollator rbc=(RuleBasedCollator)collator;
  final Object st=Reflect.invoke(RBC_GCEI,rbc,string);
  final Object sb=Reflect.invoke(RBC_GCEI,rbc,sub);
  do {
    final int cs=next(sb);
    if (cs == -1)     return 0;
    int c;
    do {
      c=next(st);
      if (c == -1)       return -1;
    }
 while (c != cs);
    final int s=(Integer)Reflect.invoke(CEI_GET_OFFSET,sb);
    if (startsWith(st,sb)) {
      if (mode == Mode.INDEX_AFTER) {
        return (int)Reflect.invoke(CEI_GET_OFFSET,st);
      }
 else       if (mode == Mode.ENDS_WITH) {
        if (next(st) == -1)         return s - 1;
      }
 else {
        return s - 1;
      }
    }
    Reflect.invoke(CEI_SET_OFFSET,sb,s);
    Reflect.invoke(CEI_RESET,sb);
  }
 while (mode != Mode.STARTS_WITH);
  return -1;
}
